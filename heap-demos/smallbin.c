#include  <stdlib.h>
#include  <string.h>
#include  <stdio.h>

/*
 * main heap:
 *
 *      ptr[1]
 *      ptr[2]
 *      ptr[3]
 *      top chunk
 *
 *
 * */

void malloc_all();
void free1();
void free2();
void free3();
void free4();
void free5();
void free6();

#define NBSIZE  128     //NormnalBinSize
#define FBSIZE  64      //FastBinSize

#define CHUNKSIZE   NBSIZE


void(*free_ptr[])() = {NULL,free1,free2,free3,free4,free5,free6};

int i;
char *ptr[10];

int main(int argc, char *argv[])
{
    malloc_all();
    i = (argc <= 1) ? 1 : (atoi(argv[1]) % 7 ? atoi(argv[1]) % 7 : 1 );
    free_ptr[i]();
}        

void malloc_all() 
{
    ptr[1] = (char*)malloc(CHUNKSIZE);
    ptr[2] = (char*)malloc(CHUNKSIZE);
    ptr[3] = (char*)malloc(CHUNKSIZE);
    ptr[4] = (char*)malloc(256*1024);       // will  mmap

    for (i=1 ; i<10;i++) {
        if(ptr[i]) {
            printf("ptr[%02d] = %p\n",i,ptr[i]);
        }
    }
}
void free1()
{
    printf("call free1: ptr1 -> ptr2 -> ptr3\n");
    getchar();
    free(ptr[1]);
    getchar();
    free(ptr[2]);
    getchar();
    free(ptr[3]);
    getchar();
}

void free2()
{
    printf("call free2: ptr1 -> ptr3 -> ptr2\n");
    getchar();
    free(ptr[1]);
    getchar();
    free(ptr[3]);
    getchar();
    free(ptr[2]);
    getchar();
}

void free3()
{
    printf("call free3: ptr2 -> ptr1 -> ptr3 \n");
    getchar();
    free(ptr[2]);
    getchar();
    free(ptr[1]);
    getchar();
    free(ptr[3]);
    getchar();
}
void free4()
{
    printf("call free4: ptr2 -> ptr3 -> ptr1\n");
    getchar();
    free(ptr[2]);
    getchar();
    free(ptr[3]);
    getchar();
    free(ptr[1]);
    getchar();
}
void free5()
{
    printf("call free5: ptr3 -> ptr1 -> ptr2\n");
    getchar();
    free(ptr[3]);
    getchar();
    free(ptr[1]);
    getchar();
    free(ptr[2]);
    getchar();
}

void free6()
{
    printf("call free6: ptr3 -> ptr2 -> ptr1\n");
    getchar();
    free(ptr[3]);
    getchar();
    free(ptr[2]);
    getchar();
    free(ptr[1]);
    getchar();
}
