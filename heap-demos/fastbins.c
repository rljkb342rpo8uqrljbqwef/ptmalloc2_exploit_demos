#include  <stdlib.h>
#include  <string.h>
#include  <stdio.h>
#include  <sys/types.h>

/*
 * main heap:
 *
 *      ptr[1]
 *      ptr[2]
 *      ptr[3]
 *      top chunk
 *
 *
 * */


#define INTERNAL_SIZE_T     size_t
#define INTERNAL_SIZE       sizeof(INTERNAL_SIZE_T)
#define MAX_FASTBIN_SIZE    ((INTERNAL_SIZE * 2) * 8)
#define CHUNKSIZE           (MAX_FASTBIN_SIZE/2)


void* malloc_wrapper(int size);
void free_wrapper(void* ptr);

void malloc_all();
void free1();
void free2();
void free3();
void free4();
void free5();
void free6();



void(*free_ptr[])() = {NULL,free1,free2,free3,free4,free5,free6};

int i;
char *ptr[10];

int main(int argc, char *argv[])
{
    malloc_all();
    i = (argc <= 1) ? 1 : (atoi(argv[1]) % 7 ? atoi(argv[1]) % 7 : 1 );
    free_ptr[i]();
}        

void malloc_all() 
{
    ptr[1] = (char*)malloc_wrapper(CHUNKSIZE);
    ptr[2] = (char*)malloc_wrapper(CHUNKSIZE);
    ptr[3] = (char*)malloc_wrapper(CHUNKSIZE);

    for (i=1 ; i<10;i++) {
        if(ptr[i]) {
            printf("ptr[%02d] = %p\n",i,ptr[i]);
        }
    }
}
void free1()
{
    printf("call free1: ptr1 -> ptr2 -> ptr3\n");
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
}

void free2()
{
    printf("call free2: ptr1 -> ptr3 -> ptr2\n");
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
}

void free3()
{
    printf("call free3: ptr2 -> ptr1 -> ptr3 \n");
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
}
void free4()
{
    printf("call free4: ptr2 -> ptr3 -> ptr1\n");
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
}
void free5()
{
    printf("call free5: ptr3 -> ptr1 -> ptr2\n");
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
}

void free6()
{
    printf("call free6: ptr3 -> ptr2 -> ptr1\n");
    printf("free ptr[3]:%p\n",ptr[3]);
    free_wrapper(ptr[3]);
    printf("free ptr[2]:%p\n",ptr[2]);
    free_wrapper(ptr[2]);
    printf("free ptr[1]:%p\n",ptr[1]);
    free_wrapper(ptr[1]);
}

void dump_heap(void* ptr)
{
    

}

void* malloc_wrapper(int size)
{
    void *ptr = NULL;
    if (size <=0) {
        printf("[-] malloc size == 0\n");
        return ptr;
    }
    ptr = malloc(size);
    if(!ptr) {
        printf("[-] malloc error\n");
        return ptr;        
    }
    dump_heap(ptr);
    return ptr;  
}

void free_wrapper(void* ptr)
{
    if (!ptr) {
        printf("[-] free pointer == NULL\n");
        return;
    }
    free(ptr);
    dump_heap(ptr);
}
