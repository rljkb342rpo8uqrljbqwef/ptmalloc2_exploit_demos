#include  <stdlib.h>
#include  <string.h>
#include  <stdio.h>

/*
 * main heap:
 *
 *      ptr[1]
 *      ptr[2]
 *      ptr[3]
 *      top chunk
 *
 *
 * */


#define CHUNKNUM 5
#define CHUNKSIZE 0x80

#define Pointer int*
#define Pointer long long*

Pointer *ptr[CHUNKNUM];
int i;


void malloc_order() 
{
    for (i=0; i<CHUNKNUM; i++) {
        ptr[i] = (Pointer)malloc(CHUNKSIZE);
        printf("ptr[%02d] = %p\n",i,ptr[i]);
    }
}

void malloc_leak()
{
    getchar();
    /**
     *heap:
     *      ptr[0]
     *      ptr[1]
     *      ptr[2]
     *      ptr[3]
     *      ptr[4]
     *      top chunk
     *
     *
     *    first free ptr[2],then free ptr[1], finally malloc(CHUNKSIZE + sizeof(Pointer)*2)
     *
     */
    free(ptr[2]);
    free(ptr[1]);
    ptr[1] = (Pointer)malloc(CHUNKSIZE + sizeof(Pointer)*2);
    printf("ptr[01] = %p\n", ptr[1]);
    getchar();
    memset(ptr[1],'1',CHUNKSIZE + sizeof(Pointer)*2);
    printf("ptr[01] = %s\n", (char*)ptr[1]);
    printf("leak_libc = %p\n", *(Pointer)((char*)ptr[1]+(CHUNKSIZE+sizeof(Pointer)*2)) );

}



int main(int argc, char *argv[])
{
    malloc_order();
    malloc_leak();
}



