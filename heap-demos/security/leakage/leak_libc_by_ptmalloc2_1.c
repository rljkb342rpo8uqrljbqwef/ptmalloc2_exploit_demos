#include  <stdlib.h>
#include  <string.h>
#include  <stdio.h>

/*
 * main heap:
 *
 *      ptr[1]
 *      ptr[2]
 *      ptr[3]
 *      top chunk
 *
 *
 * */


#define SIZE 256

#define Pointer int*

char *ptr[SIZE];
int i;


void malloc_order() 
{
    for (i=0; i<SIZE; i++) {
        ptr[i] = malloc(100*1024);
        printf("ptr[%02d] = %p\n",i,ptr[i]);
    }
    for (i=1; i<(SIZE-2); i++) {
        free(ptr[i]);
    }
}

void memset_leak()
{
    getchar();
    memset(ptr[0],'\1',(100*1024+sizeof(Pointer)));
    getchar();
    free(ptr[SIZE-2]);
    getchar();
    //printf("ptr[0] = %s\n",ptr[0]);
    printf("leak_libc = %p\n", *(Pointer)(ptr[0]+(100*1024+sizeof(Pointer)*2)) );

}

void strcpy_leak()
{
    int i = 0;
    getchar();
    char buf[100*1024+sizeof(Pointer)*2] = {'\0'};
    for(i=0 ; i< (100*1024+sizeof(Pointer)*2-1); i++) {
            buf[i] = '\1';
    }
    strcpy(ptr[0], buf);
    getchar();
    free(ptr[SIZE-2]);
    getchar();
    //printf("ptr[0] = %s\n",ptr[0]);
    printf("leak_libc = %p\n", *(Pointer)(ptr[0]+(100*1024+sizeof(Pointer)*2)) );


}


void(*leak_fn[])() = {memset_leak,strcpy_leak};

int main(int argc, char *argv[])
{
    malloc_order();
    i = (argc <= 1) ? 0 : (atoi(argv[1]) % 3 ? atoi(argv[1]) % 3 : 0 );
    leak_fn[i]();
}



